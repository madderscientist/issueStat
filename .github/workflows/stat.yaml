name: Dashboard-Stats
on:
  issues:
    types: [opened, closed, reopened]
    # , labeled, unlabeled] ä¼šé‡å¤è§¦å‘ï¼Œå› æ­¤æ³¨é‡Šæ‰ã€‚äººä¸ºåˆ†é…tagåå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - name: Set up GitHub CLI
        run: sudo apt-get update && sudo apt-get install gh -y

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # éœ€è¦ force-push tag

      - name: Aggregate stats via GraphQL
        id: stats
        shell: bash
        run: |
          set -e
          set -x
          # éœ€è¦ä¸¤ä¸ªå˜é‡ï¼šä»“åº“ owner ä¸ name
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          # 1. æ‹¿æ€» issue æ•°ï¼ˆopen + closedï¼‰
          TOTAL_QUERY='query($owner:String!,$name:String!){
            repository(owner:$owner,name:$name){
              open:issues(states:OPEN){totalCount}
              # closed:issues(states:CLOSED){totalCount}
            }
          }'
          TOTAL_JSON=$(gh api graphql -f query="$TOTAL_QUERY" -F owner="$OWNER" -F name="$REPO" --jq '.data.repository.open.totalCount')
          # [.data.repository.open.totalCount,.data.repository.closed.totalCount] | add')
          echo "total=$TOTAL_JSON" >> $GITHUB_OUTPUT

          # 2. æ‹¿æ‰€æœ‰ open issue çš„ labelsï¼ˆåˆ†é¡µåˆ°å®Œï¼‰
          LABELS_QUERY='query($owner:String!,$name:String!,$cursor:String){
            repository(owner:$owner,name:$name){
              issues(states:OPEN,first:100,after:$cursor){
                pageInfo{hasNextPage endCursor}
                nodes{labels(first:100){nodes{name}}}
              }
            }
          }'
          CURSOR=""
          declare -A COUNT
          while :; do
            RES=$(gh api graphql -f query="$LABELS_QUERY" -F owner="$OWNER" -F name="$REPO" -F cursor="$CURSOR")
            # æœ¬è½® labels è®¡æ•°
            echo "$RES" | jq -r '.data.repository.issues.nodes[]
                                 | .labels.nodes[].name' | \
            while read L; do ((COUNT[$L]++)); done
            # æ˜¯å¦ç»§ç»­åˆ†é¡µ
            HAS=$(echo "$RES" | jq -r '.data.repository.issues.pageInfo.hasNextPage')
            [[ "$HAS" == "true" ]] || break
            CURSOR=$(echo "$RES" | jq -r '.data.repository.issues.pageInfo.endCursor')
          done

          # æ‹¼ JSON å¯¹è±¡
          LABELS_JSON="{"
          for L in "${!COUNT[@]}"; do
            LABELS_JSON+="\"${L//\"/\\\"}\":${COUNT[$L]},"
          done
          LABELS_JSON="${LABELS_JSON%,}}"
          echo "labels=$LABELS_JSON" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Force-push dashboard tag ğŸ·ï¸
        run: |
          JSON="{\"total\":${{ steps.stats.outputs.total }},\
                 \"labels\":${{ steps.stats.outputs.labels }},\
                 \"updated\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ é™¤æœ¬åœ°/è¿œç¨‹æ—§ tag
          git tag -d dashboard || true
          git push origin :refs/tags/dashboard || true

          # æ–°å»ºé™„æ³¨ tag
          git tag -a dashboard -m "$JSON" ${{ github.sha }}
          git push origin dashboard --force
        env:
          GH_TOKEN: ${{ github.token }}